Ti.include('../includes/network_webservice_client.js');Ti.include('../includes/ticket_tableview.js');Ti.include('../controls/control_table_pulldown.js');var win = Titanium.UI.currentWindow;//// TICKETS GLOBAL VARIABLES SECTION//var PageNum = 1;var PageCount = 10;var AllTicketCount = 10;var tickets_id = [];//// TICKETS MAIN WINDOW INITIALIZATION//var tvTickets = Titanium.UI.createTableView({ id: 'tvTickets' });// Init pull down sectionif (Ti.Platform.osname !== 'android')	mbl_addTablePullDownHeader(tvTickets, function () { tvTickets.setData([]); }, loadTickets);function openExistingTicket(tid, completeMessage) {    var win = Titanium.UI.createWindow({		url: "ticket_view.js",		title: 'Details',		tid: tid,		tickets: tickets_id,		showCompleteMessage: completeMessage,	    _parent: Titanium.UI.currentWindow,	    navGroup : Titanium.UI.currentWindow.navGroup,	    rootWindow : Titanium.UI.currentWindow.rootWindow	});	Titanium.UI.currentWindow.navGroup.open(win);}tvTickets.addEventListener('click', function(e){	if (e.rowData.tid)		openExistingTicket(e.rowData.tid, null);	else if (e.rowData.loadMore)		setTimeout( function () {loadTickets(true); }, 300);});win.add(tvTickets);//// TOOLBAR INITIALIZATION//function addNewTicket() {    var win = Titanium.UI.createWindow({		url: "ticket_createquick.js",		title: "Add Ticket",		backButtonTitle: "Back",		_parent: Titanium.UI.currentWindow,		navGroup : Titanium.UI.currentWindow.navGroup,		rootWindow : Titanium.UI.currentWindow.rootWindow			});	Titanium.UI.currentWindow.navGroup.open(win, {animate:true});}var flexSpace = Titanium.UI.createButton({ systemButton:Titanium.UI.iPhone.SystemButton.FLEXIBLE_SPACE });  var refresh = Titanium.UI.createButton({ systemButton:Titanium.UI.iPhone.SystemButton.REFRESH });refresh.addEventListener('click', function(){	tvTickets.setData([]);//tvTickets.data = [];    loadTickets();});var previous = Titanium.UI.createButton({ systemButton:107/*Titanium.UI.iPhone.SystemButton.REWIND*/ });previous.addEventListener('click', function () {    tvTickets.setData([]);    PageNum--;    loadTickets();});var next = Titanium.UI.createButton({ systemButton:108/*Titanium.UI.iPhone.SystemButton.FAST_FORWARD*/ });next.addEventListener('click', function () {    tvTickets.setData([]);    PageNum++;    loadTickets();});var add = Titanium.UI.createButton({ systemButton:Titanium.UI.iPhone.SystemButton.COMPOSE });add.addEventListener('click', addNewTicket);var lblUpdate = Titanium.UI.createLabel({		text: 'Page ' + PageNum,	color: '#ffffff',	font: {fontSize: 14, fontWeight:'bold'}});var infLoadTickets = Titanium.UI.createProgressBar({	width:80,	min:0,	max:10,	value:0,	color:'#fff',	//message:'Downloading 0 of 10',	font:{fontSize:14, fontWeight:'bold'},	style:Titanium.UI.iPhone.ProgressBarStyle.BAR});function updateTicketsToolbar(showProgressBar){	infLoadTickets.value = 0;	if (showProgressBar) //win.toolbar	{				infLoadTickets.show();		win.setToolbar([refresh,flexSpace,previous,flexSpace,infLoadTickets,flexSpace,next,flexSpace,add], {animated:true});	}	else	{				win.setToolbar([refresh,flexSpace,previous,flexSpace,lblUpdate,flexSpace,next,flexSpace,add], {animated:true});		infLoadTickets.hide();	}}//updateTicketsToolbar(false);//// NAVBAR INITIALIZATION//var bNavAdd = Titanium.UI.createButton({ systemButton:Titanium.UI.iPhone.SystemButton.COMPOSE/*ADD*/ });bNavAdd.addEventListener('click', addNewTicket);if (Ti.Platform.osname !== 'android'){	win.setRightNavButton(bNavAdd);	win.backButtonTitle = 'Home';}//// CALLBACK EVENTS//win.addEventListener('event_ticket_created',function(e){		Ti.API.info('List: TktCreated Event Handler. Id = ' + e.createdId);	tickets_id = [e.createdId];	Ti.API.info('List: TktCreated Event Handler. tickets_id = ' + tickets_id);	openExistingTicket(e.createdId, 'Ticket Successfully Created');});win.addEventListener('event_refresh_ticket_list',function(e){	loadTickets();});//// DEFINE MAIN FUNCTION//function loadTickets(){	loadTickets(false);}function loadTickets(IsLoadMoreMode) {	function fillTicketsTableView(data)    {    	Ti.API.info(data);    	//lblUpdate.text = 'Page ' + PageNum;    	var info = eval('(' + data + ')');        var tickets = info.Tickets;        var ticketsNumber = info.TicketsNumber;        if (IsLoadMoreMode)        {        	var newtickets_id = [];        	var rowData = createTicketTableView(tickets, newtickets_id);        	for (var i = 0; i < rowData.length; i++)        	{   		        		tickets_id[AllTicketCount - PageCount + i] = newtickets_id[i];        		tvTickets.insertRowAfter(AllTicketCount - PageCount - 1 + i, rowData[i], { animate: true });        	}        	tvTickets.updateRow(AllTicketCount, createLoadMoreLabelRow(), {animationStyle:Titanium.UI.iPhone.RowAnimationStyle.TOP});        	         }        else        {        	var rowData = createTicketTableView(tickets, tickets_id); // tickets_id is referenced by ref to keep all tickets id received        	rowData[tickets.length] = createLoadMoreLabelRow();        	tvTickets.setData(rowData);                	//updateTicketsToolbar(false);        	Ti.App.fireEvent('hide_global_indicator');        	tvTickets.show();        }    }        var strRequest = "Tickets.svc?Status=1";        if (IsLoadMoreMode)    {    	strRequest += "&pg=" + (PageNum + 1) + "&ps=" + PageCount;    	tvTickets.updateRow(AllTicketCount, createLoadingMoreRow(), {animationStyle:Titanium.UI.iPhone.RowAnimationStyle.TOP});    }    else    {    	tvTickets.hide();    	Ti.App.fireEvent('show_global_indicator',{message: 'Loading...'}); //'Load Tickets'    	//updateTicketsToolbar(true);    	strRequest += "&pg=1&ps=" + AllTicketCount;    }        mbl_dataExchange("GET", strRequest,    	function () {    		    		Ti.API.info('Login HTTP Status = ' + this.status);    		Ti.API.info('Login HTTP Response = ' + this.responseText);    		if (this.status === 200)    		{    			if (IsLoadMoreMode)			    {			    				    	PageNum++;			    	AllTicketCount += PageCount;			    }        		fillTicketsTableView(this.responseText);        	}			else			{				if (!IsLoadMoreMode)					Ti.App.fireEvent('hide_global_indicator');							alert('Get Ticket List failed. Error code: ' + this.status);			}		},    	function (e) { /*infLoadTickets.value = e.progress * 10;*/ },    	function (e) {    		if (!IsLoadMoreMode)    		{    			//updateTicketsToolbar(false);    			Ti.App.fireEvent('hide_global_indicator');    		}    		else    			tvTickets.updateRow(AllTicketCount, createLoadMoreLabelRow(), {animationStyle:Titanium.UI.iPhone.RowAnimationStyle.TOP});    		alert('Ticket List Connect Error. Details: ' + JSON.stringify(e));    	});}loadTickets();